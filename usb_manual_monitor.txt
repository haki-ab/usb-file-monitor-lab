# ===============================================
# ğŸ” Script de surveillance USB avec alerte email
# Objectif : DÃ©tecter les nouveaux fichiers copiÃ©s sur la clÃ© USB
# et envoyer une alerte par email + journaliser localement
# ===============================================

# ğŸ“ Chemin du disque USB Ã  surveiller
$usbPath = "E:\"

# ğŸ“„ Fichier de journal local (logs)
$logFile = "C:\logs\usb_activity_email.log"

# âœ‰ï¸ ParamÃ¨tres de l'email (Ã  adapter selon vos besoins)
$smtpServer = "smtp.gmail.com"
$smtpPort = 587
$senderEmail = "mettre_email_ici@gmail.com"       # ğŸ‘‰ Remplacer par votre adresse Gmail
$receiverEmail = "mettre_email_ici@gmail.com"     # ğŸ‘‰ Remplacer par l'adresse du destinataire
$appPassword = "mettre_mot_de_passe_app_ici"      # ğŸ‘‰ GÃ©nÃ©rÃ© depuis votre compte Gmail (Mot de passe d'application)

# ğŸ“Œ Lire les fichiers existants (au lancement)
$existingFiles = Get-ChildItem -Path $usbPath -Recurse -ErrorAction SilentlyContinue | Select-Object -ExpandProperty FullName

Write-Host "ğŸŸ¢ Surveillance en cours sur la clÃ© USB ($usbPath)..."

while ($true) {
    Start-Sleep -Seconds 5

    # Lire les fichiers actuels
    $currentFiles = Get-ChildItem -Path $usbPath -Recurse -ErrorAction SilentlyContinue | Select-Object -ExpandProperty FullName

    # Identifier les nouveaux fichiers
    $newFiles = $currentFiles | Where-Object { $_ -notin $existingFiles }

    foreach ($file in $newFiles) {
        $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
        $message = "$timestamp - Nouveau fichier dÃ©tectÃ© sur la clÃ© USB : $file"

        # ğŸ“ Ã‰criture dans le fichier log
        Add-Content -Path $logFile -Value $message

        # âœ‰ï¸ Envoi de l'email
        $securePassword = ConvertTo-SecureString $appPassword -AsPlainText -Force
        $cred = New-Object System.Management.Automation.PSCredential($senderEmail, $securePassword)

        Send-MailMessage -From $senderEmail -To $receiverEmail -Subject "ğŸ”” Alerte Fichier USB" -Body $message -SmtpServer $smtpServer -Port $smtpPort -UseSsl -Credential $cred
    }

    # ğŸ” Mettre Ã  jour la liste des fichiers
    $existingFiles = $currentFiles
}

